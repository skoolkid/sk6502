<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at $3326</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../theme.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="3279.html">$3279</a>
</td>
<td class="up">Up: <a href="../maps/all.html#3326">Map</a></td>
<td class="next">
Next: <a href="33BF.html">$33BF</a>
</td>
</tr>
</table>
<div class="description">$3326: Print a play area tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This corresponds to <a href="https://skoolkid.github.io/skooldaze/asm/610B.html">$610B</a> in the ZX Spectrum version.
</div>
<div class="paragraph">
Used by the routine at <a href="31EA.html">$31EA</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">(<a href="0027.html">$27</a>)</td>
<td class="register-desc">Play area x-coordinate</td>
</tr>
<tr>
<td class="register">(<a href="0027.html#0028">$28</a>)</td>
<td class="register-desc">Play area y-coordinate</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="3326"></span>$3326</td>
<td class="instruction">JSR <a href="2EE6.html">$2EE6</a></td>
<td class="comment-1" rowspan="1">Compute the screen bitmap and colour information addresses for the play area tile and place them at <a href="005A.html">$5A</a> and <a href="005A.html#005C">$5C</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3329"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="2F8C.html">$2F8C</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="3329"></span>$3329</td>
<td class="instruction">LDA $27</td>
<td class="comment-1" rowspan="2">Copy the play area x-coordinate to <a href="004D.html#0052">$52</a>. This is the LSB of the base address from which the play area tile reference and colour information can be found.</td>
</tr>
<tr>
<td class="address-1"><span id="332B"></span>$332B</td>
<td class="instruction">STA $52</td>
</tr>
<tr>
<td class="address-1"><span id="332D"></span>$332D</td>
<td class="instruction">AND #$60</td>
<td class="comment-1" rowspan="6">Keep only bits 5 and 6, shift them into bits 3 and 4, add $67 and store the result ($67, $6F or $77) at <a href="004D.html#0055">$55</a>. This is the MSB of the address of the eighth byte in the skool tile at the given play area coordinates.</td>
</tr>
<tr>
<td class="address-1"><span id="332F"></span>$332F</td>
<td class="instruction">LSR A</td>
</tr>
<tr>
<td class="address-1"><span id="3330"></span>$3330</td>
<td class="instruction">LSR A</td>
</tr>
<tr>
<td class="address-1"><span id="3331"></span>$3331</td>
<td class="instruction">CLC</td>
</tr>
<tr>
<td class="address-1"><span id="3332"></span>$3332</td>
<td class="instruction">ADC #$67</td>
</tr>
<tr>
<td class="address-1"><span id="3334"></span>$3334</td>
<td class="instruction">STA $55</td>
</tr>
<tr>
<td class="address-1"><span id="3336"></span>$3336</td>
<td class="instruction">LDA $28</td>
<td class="comment-1" rowspan="4">Pick up the play area y-coordinate, add $78 and store the result at <a href="004D.html#0053">$53</a>. This is the MSB of the address at which the play area tile reference and colour information can be found.</td>
</tr>
<tr>
<td class="address-1"><span id="3338"></span>$3338</td>
<td class="instruction">CLC</td>
</tr>
<tr>
<td class="address-1"><span id="3339"></span>$3339</td>
<td class="instruction">ADC #$78</td>
</tr>
<tr>
<td class="address-1"><span id="333B"></span>$333B</td>
<td class="instruction">STA $53</td>
</tr>
<tr>
<td class="address-1"><span id="333D"></span>$333D</td>
<td class="instruction">LDY #$80</td>
<td class="comment-1" rowspan="4">Copy the colour information byte to the screen.</td>
</tr>
<tr>
<td class="address-1"><span id="333F"></span>$333F</td>
<td class="instruction">LDA ($52),Y</td>
</tr>
<tr>
<td class="address-1"><span id="3341"></span>$3341</td>
<td class="instruction">LDY #$00</td>
</tr>
<tr>
<td class="address-1"><span id="3343"></span>$3343</td>
<td class="instruction">STA ($5C),Y</td>
</tr>
<tr>
<td class="address-1"><span id="3345"></span>$3345</td>
<td class="instruction">LDA ($52),Y</td>
<td class="comment-1" rowspan="2">Pick up the skool tile reference and store it at <a href="004D.html#0054">$54</a>. This is the LSB of the address of the skool tile graphic data.</td>
</tr>
<tr>
<td class="address-1"><span id="3347"></span>$3347</td>
<td class="instruction">STA $54</td>
</tr>
<tr>
<td class="address-1"><span id="3349"></span>$3349</td>
<td class="instruction">LDX #$07</td>
<td class="comment-1" rowspan="6">Copy the skool tile graphic bytes into the buffer at <a href="4000.html">$4000</a>.</td>
</tr>
<tr>
<td class="address-2"><span id="334B"></span>$334B</td>
<td class="instruction">LDA ($54),Y</td>
</tr>
<tr>
<td class="address-1"><span id="334D"></span>$334D</td>
<td class="instruction">STA $4000,X</td>
</tr>
<tr>
<td class="address-1"><span id="3350"></span>$3350</td>
<td class="instruction">DEC $55</td>
</tr>
<tr>
<td class="address-1"><span id="3352"></span>$3352</td>
<td class="instruction">DEX</td>
</tr>
<tr>
<td class="address-1"><span id="3353"></span>$3353</td>
<td class="instruction">BPL <a href="3326.html#334B">$334B</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3355"></span>
<div class="comments">
<div class="paragraph">
The back buffer at <a href="4000.html">$4000</a> now contains a copy of the skool tile at the given coordinates. Time to superimpose the tiles of any character sprites at the same location.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="3355"></span>$3355</td>
<td class="instruction">STY $50</td>
<td class="comment-1" rowspan="1">The vector at <a href="004D.html#0050">$50</a> will be used to address sprite tile graphic data. Set the LSB to 0 now.</td>
</tr>
<tr>
<td class="address-1"><span id="3357"></span>$3357</td>
<td class="instruction">LDA #$60</td>
<td class="comment-1" rowspan="4">Prepare to address the character buffers, starting with little boy no. 1's at <a href="7860.html">$7860</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="3359"></span>$3359</td>
<td class="instruction">STA $52</td>
</tr>
<tr>
<td class="address-1"><span id="335B"></span>$335B</td>
<td class="instruction">LDA #$78</td>
</tr>
<tr>
<td class="address-1"><span id="335D"></span>$335D</td>
<td class="instruction">STA $53</td>
</tr>
<tr>
<td class="address-1"><span id="335F"></span>$335F</td>
<td class="instruction">LDX #$EB</td>
<td class="comment-1" rowspan="1"><span class="register">X</span> will count the characters.</td>
</tr>
<tr>
<td class="address-2"><span id="3361"></span>$3361</td>
<td class="instruction">LDY #$01</td>
<td class="comment-1" rowspan="1"><span class="register">Y</span>=1, pointing at the character's x-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="3363"></span>$3363</td>
<td class="instruction">LDA $27</td>
<td class="comment-1" rowspan="1">Pick up the play area x-coordinate from <a href="0027.html">$27</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="3365"></span>$3365</td>
<td class="instruction">SEC</td>
<td class="comment-1" rowspan="2">Subtract the character's x-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="3366"></span>$3366</td>
<td class="instruction">SBC ($52),Y</td>
</tr>
<tr>
<td class="address-1"><span id="3368"></span>$3368</td>
<td class="instruction">CMP #$03</td>
<td class="comment-1" rowspan="1">Is the result less than 3?</td>
</tr>
<tr>
<td class="address-1"><span id="336A"></span>$336A</td>
<td class="instruction">BCS <a href="3326.html#33B0">$33B0</a></td>
<td class="comment-1" rowspan="1">Branch if not.</td>
</tr>
<tr>
<td class="address-1"><span id="336C"></span>$336C</td>
<td class="instruction">ASL A</td>
<td class="comment-1" rowspan="3">Multiply by 4 and store the result (0, 4, 8) at <a href="004D.html#0055">$55</a>. This indicates the column (left, middle, right) of the character's sprite that aligns with the play area x-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="336D"></span>$336D</td>
<td class="instruction">ASL A</td>
</tr>
<tr>
<td class="address-1"><span id="336E"></span>$336E</td>
<td class="instruction">STA $55</td>
</tr>
<tr>
<td class="address-1"><span id="3370"></span>$3370</td>
<td class="instruction">LDA $28</td>
<td class="comment-1" rowspan="1">Pick up the play area y-coordinate from <a href="0027.html#0028">$28</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="3372"></span>$3372</td>
<td class="instruction">INY</td>
<td class="comment-1" rowspan="1"><span class="register">Y</span>=2, pointing at the character's y-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="3373"></span>$3373</td>
<td class="instruction">SEC</td>
<td class="comment-1" rowspan="2">Subtract the character's y-coordinate from the play area y-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="3374"></span>$3374</td>
<td class="instruction">SBC ($52),Y</td>
</tr>
<tr>
<td class="address-1"><span id="3376"></span>$3376</td>
<td class="instruction">CMP #$04</td>
<td class="comment-1" rowspan="1">Is the result less than 4?</td>
</tr>
<tr>
<td class="address-1"><span id="3378"></span>$3378</td>
<td class="instruction">BCS <a href="3326.html#33B0">$33B0</a></td>
<td class="comment-1" rowspan="1">Branch if not.</td>
</tr>
<tr>
<td class="address-1"><span id="337A"></span>$337A</td>
<td class="instruction">ADC $55</td>
<td class="comment-1" rowspan="3">Add this y-coordinate difference (0, 1, 2, 3) and $8D to <a href="004D.html#0055">$55</a> to get the MSB of the relevant animatory state tile reference.</td>
</tr>
<tr>
<td class="address-1"><span id="337C"></span>$337C</td>
<td class="instruction">ADC #$8D</td>
</tr>
<tr>
<td class="address-1"><span id="337E"></span>$337E</td>
<td class="instruction">STA $55</td>
</tr>
<tr>
<td class="address-1"><span id="3380"></span>$3380</td>
<td class="instruction">LDY #$00</td>
<td class="comment-1" rowspan="1"><span class="register">Y</span>=0, pointing at the character's animatory state.</td>
</tr>
<tr>
<td class="address-1"><span id="3382"></span>$3382</td>
<td class="instruction">LDA ($52),Y</td>
<td class="comment-1" rowspan="2">Pick up the character's animatory state and store it at <a href="004D.html#0054">$54</a>. This is the LSB of the address of the animatory state tile reference.</td>
</tr>
<tr>
<td class="address-1"><span id="3384"></span>$3384</td>
<td class="instruction">STA $54</td>
</tr>
<tr>
<td class="address-1"><span id="3386"></span>$3386</td>
<td class="instruction">LDA ($54),Y</td>
<td class="comment-1" rowspan="1">Pick up a tile reference for the character's animatory state.</td>
</tr>
<tr>
<td class="address-1"><span id="3388"></span>$3388</td>
<td class="instruction">BEQ <a href="3326.html#33B0">$33B0</a></td>
<td class="comment-1" rowspan="1">Branch if it's zero (the blank tile).</td>
</tr>
<tr>
<td class="address-1"><span id="338A"></span>$338A</td>
<td class="instruction">TAY</td>
<td class="comment-1" rowspan="1">Transfer the tile reference to <span class="register">Y</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="338B"></span>$338B</td>
<td class="instruction">TXA</td>
<td class="comment-1" rowspan="2">Save the character counter temporarily.</td>
</tr>
<tr>
<td class="address-1"><span id="338C"></span>$338C</td>
<td class="instruction">PHA</td>
</tr>
<tr>
<td class="address-1"><span id="338D"></span>$338D</td>
<td class="instruction">LDA #$A8</td>
<td class="comment-1" rowspan="1">The sprite graphic data for the boys and the catapult pellet is in pages <a href="9900.html">$99-$A8</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="338F"></span>$338F</td>
<td class="instruction">CPX #$F6</td>
<td class="comment-1" rowspan="1">Are we still dealing with little boys 1-11?</td>
</tr>
<tr>
<td class="address-1"><span id="3391"></span>$3391</td>
<td class="instruction">BCC <a href="3326.html#3399">$3399</a></td>
<td class="comment-1" rowspan="1">Branch if so.</td>
</tr>
<tr>
<td class="address-1"><span id="3393"></span>$3393</td>
<td class="instruction">CPX #$FA</td>
<td class="comment-1" rowspan="1">Are we dealing with a teacher?</td>
</tr>
<tr>
<td class="address-1"><span id="3395"></span>$3395</td>
<td class="instruction">BCS <a href="3326.html#3399">$3399</a></td>
<td class="comment-1" rowspan="1">Branch if not.</td>
</tr>
<tr>
<td class="address-1"><span id="3397"></span>$3397</td>
<td class="instruction">LDA #$B8</td>
<td class="comment-1" rowspan="1">The sprite graphic data for the teachers is in pages <a href="A900.html">$A9-$B8</a>.</td>
</tr>
<tr>
<td class="address-2"><span id="3399"></span>$3399</td>
<td class="instruction">STA $51</td>
<td class="comment-1" rowspan="1">Set the MSB of the sprite tile graphic data address at <a href="004D.html#0051">$51</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="339B"></span>$339B</td>
<td class="instruction">LDX #$07</td>
<td class="comment-1" rowspan="1"><span class="register">X</span> will count the bytes in sprite tile.</td>
</tr>
<tr>
<td class="address-2"><span id="339D"></span>$339D</td>
<td class="instruction">LDA ($50),Y</td>
<td class="comment-1" rowspan="5">Modify a byte of the tile in the back buffer at <a href="4000.html">$4000</a> by superimposing a sprite tile byte (using a mask).</td>
</tr>
<tr>
<td class="address-1"><span id="339F"></span>$339F</td>
<td class="instruction">AND $4000,X</td>
</tr>
<tr>
<td class="address-1"><span id="33A2"></span>$33A2</td>
<td class="instruction">DEC $51</td>
</tr>
<tr>
<td class="address-1"><span id="33A4"></span>$33A4</td>
<td class="instruction">ORA ($50),Y</td>
</tr>
<tr>
<td class="address-1"><span id="33A6"></span>$33A6</td>
<td class="instruction">STA $4000,X</td>
</tr>
<tr>
<td class="address-1"><span id="33A9"></span>$33A9</td>
<td class="instruction">DEC $51</td>
<td class="comment-1" rowspan="1">Point at the next sprite tile mask byte.</td>
</tr>
<tr>
<td class="address-1"><span id="33AB"></span>$33AB</td>
<td class="instruction">DEX</td>
<td class="comment-1" rowspan="1">Have we superimposed the entire sprite tile yet?</td>
</tr>
<tr>
<td class="address-1"><span id="33AC"></span>$33AC</td>
<td class="instruction">BPL <a href="3326.html#339D">$339D</a></td>
<td class="comment-1" rowspan="1">Branch back if not.</td>
</tr>
<tr>
<td class="address-1"><span id="33AE"></span>$33AE</td>
<td class="instruction">PLA</td>
<td class="comment-1" rowspan="2">Restore the character counter to <span class="register">X</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="33AF"></span>$33AF</td>
<td class="instruction">TAX</td>
</tr>
<tr>
<td class="address-2"><span id="33B0"></span>$33B0</td>
<td class="instruction">INC $53</td>
<td class="comment-1" rowspan="1">Next character buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="33B2"></span>$33B2</td>
<td class="instruction">INX</td>
<td class="comment-1" rowspan="1">Have we checked every character yet?</td>
</tr>
<tr>
<td class="address-1"><span id="33B3"></span>$33B3</td>
<td class="instruction">BNE <a href="3326.html#3361">$3361</a></td>
<td class="comment-1" rowspan="1">Branch back if not.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33B5"></span>
<div class="comments">
<div class="paragraph">
The tile in the back buffer at <a href="4000.html">$4000</a> now consists of the skool tile with all relevant sprite tiles superimposed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="33B5"></span>$33B5</td>
<td class="instruction">LDY #$07</td>
<td class="comment-1" rowspan="5">Copy the tile from the back buffer to the screen.</td>
</tr>
<tr>
<td class="address-2"><span id="33B7"></span>$33B7</td>
<td class="instruction">LDA ($5E),Y</td>
</tr>
<tr>
<td class="address-1"><span id="33B9"></span>$33B9</td>
<td class="instruction">STA ($5A),Y</td>
</tr>
<tr>
<td class="address-1"><span id="33BB"></span>$33BB</td>
<td class="instruction">DEY</td>
</tr>
<tr>
<td class="address-1"><span id="33BC"></span>$33BC</td>
<td class="instruction">BPL <a href="3326.html#33B7">$33B7</a></td>
</tr>
<tr>
<td class="address-1"><span id="33BE"></span>$33BE</td>
<td class="instruction">RTS</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="3279.html">$3279</a>
</td>
<td class="up">Up: <a href="../maps/all.html#3326">Map</a></td>
<td class="next">
Next: <a href="33BF.html">$33BF</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze C64 disassembly 20210325</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4 and <a href="https://github.com/skoolkid/sk6502">sk6502</a>.</div>
</footer>
</body>
</html>