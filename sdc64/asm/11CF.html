<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at $11CF</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../theme.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1129.html">$1129</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11CF">Map</a></td>
<td class="next">
Next: <a href="126D.html">$126D</a>
</td>
</tr>
</table>
<div class="description">$11CF: Write a single character on a blackboard</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This corresponds to <a href="https://skoolkid.github.io/skooldaze/asm/7142.html">$7142</a> in the ZX Spectrum version.
</div>
<div class="paragraph">
Used by the routines at <a href="1129.html">$1129</a> and <a href="184E.html">$184E</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Character code ($20-$7F)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="11CF"></span>$11CF</td>
<td class="instruction">STA $21</td>
<td class="comment-1" rowspan="3">Store the address that holds the font character bitmap width at <a href="0021.html">$21</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="11D1"></span>$11D1</td>
<td class="instruction">LDA #$47</td>
</tr>
<tr>
<td class="address-1"><span id="11D3"></span>$11D3</td>
<td class="instruction">STA $22</td>
</tr>
<tr>
<td class="address-1"><span id="11D5"></span>$11D5</td>
<td class="instruction">LDA $19</td>
<td class="comment-1" rowspan="1">Pick up the blackboard's pixel column counter from <a href="0019.html">$19</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="11D7"></span>$11D7</td>
<td class="instruction">ORA #$C0</td>
<td class="comment-1" rowspan="1">Set bits 6 and 7.</td>
</tr>
<tr>
<td class="address-1"><span id="11D9"></span>$11D9</td>
<td class="instruction">CLC</td>
<td class="comment-1" rowspan="2">Add 1 to advance to the next pixel column.</td>
</tr>
<tr>
<td class="address-1"><span id="11DA"></span>$11DA</td>
<td class="instruction">ADC #$01</td>
</tr>
<tr>
<td class="address-1"><span id="11DC"></span>$11DC</td>
<td class="instruction">BCS <a href="11CF.html#11E5">$11E5</a></td>
<td class="comment-1" rowspan="1">Branch if we've reached the end of a line.</td>
</tr>
<tr>
<td class="address-1"><span id="11DE"></span>$11DE</td>
<td class="instruction">LDY #$00</td>
<td class="comment-1" rowspan="3">Add the width of the font character bitmap.</td>
</tr>
<tr>
<td class="address-1"><span id="11E0"></span>$11E0</td>
<td class="instruction">CLC</td>
</tr>
<tr>
<td class="address-1"><span id="11E1"></span>$11E1</td>
<td class="instruction">ADC ($21),Y</td>
</tr>
<tr>
<td class="address-1"><span id="11E3"></span>$11E3</td>
<td class="instruction">BCC <a href="11CF.html#11ED">$11ED</a></td>
<td class="comment-1" rowspan="1">Branch if the bitmap will fit on the current line.</td>
</tr>
<tr>
<td class="address-2"><span id="11E5"></span>$11E5</td>
<td class="instruction">LDA $19</td>
<td class="comment-1" rowspan="4">Set the blackboard's pixel column counter at <a href="0019.html">$19</a> to either $00 (start of the top line) or $40 (start of the bottom line).</td>
</tr>
<tr>
<td class="address-1"><span id="11E7"></span>$11E7</td>
<td class="instruction">AND #$40</td>
</tr>
<tr>
<td class="address-1"><span id="11E9"></span>$11E9</td>
<td class="instruction">EOR #$40</td>
</tr>
<tr>
<td class="address-1"><span id="11EB"></span>$11EB</td>
<td class="instruction">STA $19</td>
</tr>
<tr>
<td class="address-2"><span id="11ED"></span>$11ED</td>
<td class="instruction">LDA $19</td>
<td class="comment-1" rowspan="1">Pick up the blackboard's pixel column counter from <a href="0019.html">$19</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="11EF"></span>$11EF</td>
<td class="instruction">AND #$3F</td>
<td class="comment-1" rowspan="6">Clear bits 6 and 7, divide by 8, and add the x-coordinate of the top left corner of the blackboard. This gives the play area x-coordinate of the target character cell.</td>
</tr>
<tr>
<td class="address-1"><span id="11F1"></span>$11F1</td>
<td class="instruction">LSR A</td>
</tr>
<tr>
<td class="address-1"><span id="11F2"></span>$11F2</td>
<td class="instruction">LSR A</td>
</tr>
<tr>
<td class="address-1"><span id="11F3"></span>$11F3</td>
<td class="instruction">LSR A</td>
</tr>
<tr>
<td class="address-1"><span id="11F4"></span>$11F4</td>
<td class="instruction">CLC</td>
</tr>
<tr>
<td class="address-1"><span id="11F5"></span>$11F5</td>
<td class="instruction">ADC $15</td>
</tr>
<tr>
<td class="address-1"><span id="11F7"></span>$11F7</td>
<td class="instruction">STA $15</td>
<td class="comment-1" rowspan="1">Store this x-coordinate at <a href="0015.html">$15</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="11F9"></span>$11F9</td>
<td class="instruction">LDA $19</td>
<td class="comment-1" rowspan="1">Pick up the blackboard's pixel column counter from <a href="0019.html">$19</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="11FB"></span>$11FB</td>
<td class="instruction">CMP #$40</td>
<td class="comment-1" rowspan="1">Are we on the top line of the blackboard?</td>
</tr>
<tr>
<td class="address-1"><span id="11FD"></span>$11FD</td>
<td class="instruction">BCC <a href="11CF.html#1201">$1201</a></td>
<td class="comment-1" rowspan="1">Branch if so.</td>
</tr>
<tr>
<td class="address-1"><span id="11FF"></span>$11FF</td>
<td class="instruction">INC $16</td>
<td class="comment-1" rowspan="1">Increment the target blackboard character cell y-coordinate at <a href="0015.html#0016">$16</a>.</td>
</tr>
<tr>
<td class="address-2"><span id="1201"></span>$1201</td>
<td class="instruction">LDA $15</td>
<td class="comment-1" rowspan="1">Pick up the target blackboard character cell x-coordinate from <a href="0015.html">$15</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1203"></span>$1203</td>
<td class="instruction">SEC</td>
<td class="comment-1" rowspan="2">Subtract the x-coordinate of the leftmost column of the skool on screen, giving the screen x-coordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="1204"></span>$1204</td>
<td class="instruction">SBC $58</td>
</tr>
<tr>
<td class="address-1"><span id="1206"></span>$1206</td>
<td class="instruction">STA $49</td>
<td class="comment-1" rowspan="1">Store this screen x-coordinate at <a href="0047.html#0049">$49</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1208"></span>$1208</td>
<td class="instruction">LDA $16</td>
<td class="comment-1" rowspan="2">Copy the target blackboard character cell y-coordinate from <a href="0015.html#0016">$16</a> to <a href="0047.html#004A">$4A</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="120A"></span>$120A</td>
<td class="instruction">STA $4A</td>
</tr>
<tr>
<td class="address-1"><span id="120C"></span>$120C</td>
<td class="instruction">JSR <a href="36E3.html">$36E3</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the target blackboard character cell.</td>
</tr>
<tr>
<td class="address-1"><span id="120F"></span>$120F</td>
<td class="instruction">INC $49</td>
<td class="comment-1" rowspan="1">Increment the x-coordinate at <a href="0047.html#0049">$49</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1211"></span>$1211</td>
<td class="instruction">JSR <a href="36E3.html">$36E3</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the next character cell to the right.</td>
</tr>
<tr>
<td class="address-1"><span id="1214"></span>$1214</td>
<td class="instruction">LDA $19</td>
<td class="comment-1" rowspan="1">Pick up the blackboard's pixel column counter from <a href="0019.html">$19</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1216"></span>$1216</td>
<td class="instruction">AND #$07</td>
<td class="comment-1" rowspan="8">Prepare a mask in <span class="register">A</span> such that the only reset bit corresponds to the target pixel column in the target character cell.</td>
</tr>
<tr>
<td class="address-1"><span id="1218"></span>$1218</td>
<td class="instruction">TAX</td>
</tr>
<tr>
<td class="address-1"><span id="1219"></span>$1219</td>
<td class="instruction">INX</td>
</tr>
<tr>
<td class="address-1"><span id="121A"></span>$121A</td>
<td class="instruction">LDA #$FF</td>
</tr>
<tr>
<td class="address-1"><span id="121C"></span>$121C</td>
<td class="instruction">CLC</td>
</tr>
<tr>
<td class="address-2"><span id="121D"></span>$121D</td>
<td class="instruction">ROR A</td>
</tr>
<tr>
<td class="address-1"><span id="121E"></span>$121E</td>
<td class="instruction">DEX</td>
</tr>
<tr>
<td class="address-1"><span id="121F"></span>$121F</td>
<td class="instruction">BNE <a href="11CF.html#121D">$121D</a></td>
</tr>
<tr>
<td class="address-1"><span id="1221"></span>$1221</td>
<td class="instruction">STA $23</td>
<td class="comment-1" rowspan="1">Store this mask at <a href="0021.html#0023">$23</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1223"></span>$1223</td>
<td class="instruction">JSR <a href="1294.html">$1294</a></td>
<td class="comment-1" rowspan="1">Get the address of the skool tile corresponding to the blackboard character cell.</td>
</tr>
<tr>
<td class="address-1"><span id="1226"></span>$1226</td>
<td class="instruction">LDY #$00</td>
<td class="comment-1" rowspan="3">Pick up the font character bitmap width and store this counter at <a href="004D.html#004E">$4E</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1228"></span>$1228</td>
<td class="instruction">LDA ($21),Y</td>
</tr>
<tr>
<td class="address-1"><span id="122A"></span>$122A</td>
<td class="instruction">STA $4E</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="122C"></span>
<div class="comments">
<div class="paragraph">
The loop that draws the font character into the blackboard character cell starts here.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="122C"></span>$122C</td>
<td class="instruction">INC $22</td>
<td class="comment-1" rowspan="1">Point at the next pixel column of the font character bitmap.</td>
</tr>
<tr>
<td class="address-1"><span id="122E"></span>$122E</td>
<td class="instruction">LDA #$08</td>
<td class="comment-1" rowspan="1">There are 8 pixels in the column to be drawn.</td>
</tr>
<tr>
<td class="address-1"><span id="1230"></span>$1230</td>
<td class="instruction">STA $4F</td>
<td class="comment-1" rowspan="1">Store this counter at <a href="004D.html#004F">$4F</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1232"></span>$1232</td>
<td class="instruction">LDA ($21),Y</td>
<td class="comment-1" rowspan="1">Pick up the next pixel column of the font character bitmap.</td>
</tr>
<tr>
<td class="address-2"><span id="1234"></span>$1234</td>
<td class="instruction">ROL A</td>
<td class="comment-1" rowspan="1">Push the bit to be drawn into the carry flag.</td>
</tr>
<tr>
<td class="address-1"><span id="1235"></span>$1235</td>
<td class="instruction">PHA</td>
<td class="comment-1" rowspan="1">Save the remainder of the pixel column temporarily.</td>
</tr>
<tr>
<td class="address-1"><span id="1236"></span>$1236</td>
<td class="instruction">BCC <a href="11CF.html#123E">$123E</a></td>
<td class="comment-1" rowspan="1">Branch if the pixel is a 0 (nothing to draw).</td>
</tr>
<tr>
<td class="address-1"><span id="1238"></span>$1238</td>
<td class="instruction">LDA $23</td>
<td class="comment-1" rowspan="3">Pick up the mask from <a href="0021.html#0023">$23</a> and apply it to the skool tile graphic data byte for the target blackboard character cell.</td>
</tr>
<tr>
<td class="address-1"><span id="123A"></span>$123A</td>
<td class="instruction">AND ($1B),Y</td>
</tr>
<tr>
<td class="address-1"><span id="123C"></span>$123C</td>
<td class="instruction">STA ($1B),Y</td>
</tr>
<tr>
<td class="address-2"><span id="123E"></span>$123E</td>
<td class="instruction">INC $1C</td>
<td class="comment-1" rowspan="1">Move to the next byte of skool tile graphic data.</td>
</tr>
<tr>
<td class="address-1"><span id="1240"></span>$1240</td>
<td class="instruction">PLA</td>
<td class="comment-1" rowspan="1">Restore the remainder of the pixel column to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="1241"></span>$1241</td>
<td class="instruction">DEC $4F</td>
<td class="comment-1" rowspan="1">Have we drawn all 8 pixels in the column yet?</td>
</tr>
<tr>
<td class="address-1"><span id="1243"></span>$1243</td>
<td class="instruction">BNE <a href="11CF.html#1234">$1234</a></td>
<td class="comment-1" rowspan="1">Branch back if not.</td>
</tr>
<tr>
<td class="address-1"><span id="1245"></span>$1245</td>
<td class="instruction">INC $19</td>
<td class="comment-1" rowspan="2">Increment the blackboard's pixel column counter at <a href="0019.html">$19</a> and pick up the new value.</td>
</tr>
<tr>
<td class="address-1"><span id="1247"></span>$1247</td>
<td class="instruction">LDA $19</td>
</tr>
<tr>
<td class="address-1"><span id="1249"></span>$1249</td>
<td class="instruction">AND #$07</td>
<td class="comment-1" rowspan="1">Have we just drawn in the rightmost pixel column of the target character cell?</td>
</tr>
<tr>
<td class="address-1"><span id="124B"></span>$124B</td>
<td class="instruction">BEQ <a href="11CF.html#1257">$1257</a></td>
<td class="comment-1" rowspan="1">Branch if so.</td>
</tr>
<tr>
<td class="address-1"><span id="124D"></span>$124D</td>
<td class="instruction">LDA $1C</td>
<td class="comment-1" rowspan="4">Reset the skool tile graphic data pointer back to the first byte in the tile.</td>
</tr>
<tr>
<td class="address-1"><span id="124F"></span>$124F</td>
<td class="instruction">SEC</td>
</tr>
<tr>
<td class="address-1"><span id="1250"></span>$1250</td>
<td class="instruction">SBC #$08</td>
</tr>
<tr>
<td class="address-1"><span id="1252"></span>$1252</td>
<td class="instruction">STA $1C</td>
</tr>
<tr>
<td class="address-1"><span id="1254"></span>$1254</td>
<td class="instruction">JMP <a href="11CF.html#125C">$125C</a></td>
<td class="comment-1" rowspan="1">Jump forward.</td>
</tr>
<tr>
<td class="address-2"><span id="1257"></span>$1257</td>
<td class="instruction">INC $15</td>
<td class="comment-1" rowspan="1">Increment the target blackboard cell x-coordinate at <a href="0015.html">$15</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="1259"></span>$1259</td>
<td class="instruction">JSR <a href="1294.html">$1294</a></td>
<td class="comment-1" rowspan="1">Get the address of the skool tile corresponding to the blackboard character cell.</td>
</tr>
<tr>
<td class="address-2"><span id="125C"></span>$125C</td>
<td class="instruction">DEC $4E</td>
<td class="comment-1" rowspan="1">Have we drawn every pixel column in the font character bitmap now?</td>
</tr>
<tr>
<td class="address-1"><span id="125E"></span>$125E</td>
<td class="instruction">BEQ <a href="11CF.html#126A">$126A</a></td>
<td class="comment-1" rowspan="1">Branch if so.</td>
</tr>
<tr>
<td class="address-1"><span id="1260"></span>$1260</td>
<td class="instruction">SEC</td>
<td class="comment-1" rowspan="2">Otherwise shift the reset bit in the mask at <a href="0021.html#0023">$23</a> one place to right, ready for the next pixel column.</td>
</tr>
<tr>
<td class="address-1"><span id="1261"></span>$1261</td>
<td class="instruction">ROR $23</td>
</tr>
<tr>
<td class="address-1"><span id="1263"></span>$1263</td>
<td class="instruction">BCS <a href="11CF.html#122C">$122C</a></td>
<td class="comment-1" rowspan="1">Branch unless the reset bit fell into the carry flag.</td>
</tr>
<tr>
<td class="address-1"><span id="1265"></span>$1265</td>
<td class="instruction">ROR $23</td>
<td class="comment-1" rowspan="1">Rotate the reset bit into bit 7.</td>
</tr>
<tr>
<td class="address-1"><span id="1267"></span>$1267</td>
<td class="instruction">JMP <a href="11CF.html#122C">$122C</a></td>
<td class="comment-1" rowspan="1">Jump back to start drawing the next pixel column.</td>
</tr>
<tr>
<td class="address-2"><span id="126A"></span>$126A</td>
<td class="instruction">INC $19</td>
<td class="comment-1" rowspan="1">Increment the blackboard's pixel column counter at <a href="0019.html">$19</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="126C"></span>$126C</td>
<td class="instruction">RTS</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1129.html">$1129</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11CF">Map</a></td>
<td class="next">
Next: <a href="126D.html">$126D</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze C64 disassembly 20210325</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4 and <a href="https://github.com/skoolkid/sk6502">sk6502</a>.</div>
</footer>
</body>
</html>